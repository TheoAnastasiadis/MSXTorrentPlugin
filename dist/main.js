(()=>{"use strict";function t(t,e,o){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var i=o.call(t,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}class e{constructor(e,o){t(this,"streamTorrent",(async t=>{let e=await navigator.serviceWorker.register("sw.js",{scope:"./"});for(;!e.active;);await this.client.loadWorker(e.active),console.log("Service Worker ready"),this.client.on("error",(function(t){console.error("ERROR: "+t.message)})),this.client.add(this.torrentId,(async e=>{e.on("warning",(t=>{console.warn(t)})),e.on("error",(t=>{console.error(t)})),e.files[this.fileIdx].streamTo(t)}))})),this.torrentId=e,this.fileIdx=o,this.client=new window.WebTorrent}}function o(t,e){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6e3,r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return function*(){let s=0;const n=new AbortController;async function a(t){if(!(s<o)||n.signal.aborted){if(n.signal.aborted)throw"aborted";return await new Promise(((t,e)=>setTimeout(t,i))),await a(t)}try{s++;const o=await e(t);if(n.signal.aborted)throw"aborted";return r&&n.abort(),o}finally{s--}}for(const e of t)yield a(e)}()}function i(t,e,o){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var i=o.call(t,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}t(e,"IS_CLIENT_COMPATIBLE",(()=>WebTorrent.WEBRTC_SUPPORT&&!!navigator.serviceWorker));class r{constructor(t,e,r){i(this,"responseTimeout",6e3),i(this,"retryTimeout",2e3),i(this,"concurrency",8),i(this,"MOST_POPULAR_GETAWAYS",["192.168.1.1","192.168.0.1","192.168.2.1","192.168.1.254","192.168.10.1","192.168.100.1","192.168.0.50","192.168.0.254","192.168.88.1","192.168.123.254","192.168.8.1","10.0.0.1","192.168.1.2","192.168.11.1","10.0.0.2","192.168.1.240","192.168.1.250","192.168.3.1","192.168.20.1","10.0.0.138","192.168.254.254","192.168.15.1","172.19.3.1","192.168.1.245","10.1.1.1","192.168.10.100","192.168.16.1","10.10.10.254","192.168.0.20","192.168.0.100","192.168.178.1","192.168.0.30","192.168.1.20","192.168.2.2","192.168.1.253","192.168.0.10","192.168.2.254","10.10.10.1","192.168.0.99","192.168.1.100","192.168.31.1","192.168.168.168","192.168.100.252","192.168.62.1","192.168.50.1","192.168.111.1","192.168.1.252","192.168.1.230","192.168.30.1","192.168.10.30","192.168.8.254","192.168.0.228","10.0.10.254","192.168.0.101","172.16.0.1","192.168.200.1","192.168.0.32","192.168.1.226","10.0.1.1","10.90.90.91","169.254.128.132","192.168.0.227","192.168.169.1","192.168.6.1","192.168.168.1","192.168.1.200","192.168.1.10","192.168.1.99","192.168.1.241","192.168.7.2","192.168.61.1","192.168.80.240","222.222.222.1","10.90.90.90","192.168.9.2","10.1.0.99","172.23.56.254","192.168.0.2","192.168.18.1","192.168.10.110","10.10.1.1","192.168.16.254","10.1.10.1","192.0.2.1","192.168.5.1","192.168.1.251","192.168.16.168","192.168.190.1","192.168.22.1","192.168.1.225","192.168.123.1","192.168.42.1","192.168.0.40","192.168.40.1","192.168.0.35","192.168.32.1","192.168.0.4","10.8.0.99","192.168.0.3"]),i(this,"updatePossibleIps",(()=>{if(this.possibleLocalIps=[],!this.getaway)throw"No getaway detected. Impossible to parse local ips.";const t=this.getaway.split(".").splice(0,3).join(".");for(let e=0;e<=255;e++)this.possibleLocalIps.push(t+"."+e)})),i(this,"checkAddress",(t=>{const e=this.responseTimeout;return new Promise(((o,i)=>{const r=new WebSocket(`wss://${t}/`),s=Date.now();setTimeout((()=>r.close()),e),r.onclose=r=>{Date.now()-s<e?(console.log(`Possible local ip: ${t}`),o(t)):i(t)}}))})),i(this,"checkServer",(async t=>{const e=new AbortController;setTimeout((()=>e.abort()),this.responseTimeout);const o=await fetch(`http://${t}`,{signal:e.signal});if(!e.signal.aborted)return{ip:t,text:await o.text()+""}})),i(this,"detectGetaway",(async()=>{this.getaway=await Promise.any(o(this.MOST_POPULAR_GETAWAYS,this.checkAddress,this.concurrency,this.retryTimeout,!0)),this.updatePossibleIps()})),this.responseTimeout=t||this.responseTimeout,this.retryTimeout=e||this.retryTimeout,this.concurrency=r||this.concurrency,this.getaway=null,this.privateIps=[],this.possibleLocalIps=[]}}function s(t,e,o){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var i=o.call(t,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}class n{constructor(){var t=this;let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;s(this,"TIMEOUT",6e3),s(this,"MAX_CONNECTIONS",3),s(this,"PORT",8090),s(this,"init",(async function(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const o=await fetch(`http://${t.url}:${t.PORT}/echo`);if(t.version=await o.text(),!t.version.match(/MatriX\.\d{1,3}/)){if(!e)throw"No server at IP";if(await t.detectUrl(),!t.version.match(/MatriX\.\d{1,3}/))throw"No server in network"}console.log(`Server ready at '${t.url}'`)})),s(this,"detectUrl",(async()=>{const t=new r(this.TIMEOUT,this.TIMEOUT/4);await t.detectGetaway();const e=await Promise.any(o(t.possibleLocalIps,(async e=>{await t.checkAddress(e);const o=await t.checkServer(`${e}:8090/echo`);if(o?.text.match(/MatriX\.\d{1,3}/))return{ip:e,version:o.text};throw`No TorrServer here (${e})`}),this.MAX_CONNECTIONS,this.TIMEOUT,!0));this.url=e.ip,this.version=e.version})),s(this,"streamTorrent",(async(t,e,o)=>{const i={link:t,index:e,m3u:!0},r=await fetch(`http://${this.url}:${this.PORT}/stream?${new URLSearchParams(i)}`);console.log(await r.text())})),this.url=e,this.version=null}}const a="torrent:",l=(t,e)=>{console.log(t),TVXVideoPlugin.error(t),e()};class c{constructor(){this.videoElement=document.getElementById("video"),this.player=null,this.init=()=>{},this.ready=()=>{console.log("init()"),TVXVideoPlugin.requestData("video:info",(t=>{console.log("TVX.requestData()");const o=t?.video?.info;console.dir(o);const[i,r]=(t=>{const e=TVXPropertyTools.getFullStr(t,a+"id",null)||new TVXUrlParams(window.location.href).getFullStr("torrent",null);console.log("torrent",e);const o=TVXPropertyTools.getNum(t,a+"fileIdx",null)||new TVXUrlParams(window.location.href).getNum("fileIdx",0);return console.log("file",o),e||l("Error: No torrent id (infoHash, magnerURI or .torrent file) specified.",(()=>{throw"No torrent id"})),[e,o]})(o);console.log(i,r);const s=TVXPropertyTools.getBool(o,a+"server:precedence",!1);console.log(1);const c=e.IS_CLIENT_COMPATIBLE();console.log(2),console.log("parsed info");const h=async()=>{console.log("Setting remote player");const t=TVXPropertyTools.getFullStr(o,a+"server:location","auto");"auto"!=t?this.player=new n(t):(this.player=new n,this.player.detectUrl());try{await this.player.init(),this.player.streamTorrent(i,r,this.videoElement)}catch(e){l("auto"==t?"No server was found in this network":"No server was found at the specified IP",(()=>{console.error(e)}))}};s?h():c?(()=>{console.log("Setting local player"),this.player=new e(i,r),this.player.streamTorrent(this.videoElement)})():l("Your system does not support WebTorrent. Will try to find a  TorrServer as fallback...",h)})),TVXVideoPlugin.startPlayback()},this.play=this.videoElement.play,this.pause=this.videoElement.pause,this.stop=()=>{this.videoElement.pause(),TVXVideoPlugin.stopPlayback()},this.getDuration=()=>this.videoElement.duration,this.getPosition=()=>this.videoElement.currentTime,this.getSpeed=()=>this.videoElement.playbackRate,this.setSpeed=t=>{this.videoElement.playbackRate=t},this.setPosition=t=>{this.videoElement.currentTime=t},this.isMuted=()=>this.videoElement.muted,this.setMuted=()=>{this.videoElement.muted=!0},this.getUpdateData=()=>({position:this.getPosition(),duration:this.getDuration(),speed:this.getSpeed()})}}TVXPluginTools.onReady((function(){TVXVideoPlugin.setupPlayer(new c),TVXVideoPlugin.init()}))})();