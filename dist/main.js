(()=>{"use strict";function t(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class e{constructor(e,i){t(this,"streamTorrent",(async t=>{let e=await navigator.serviceWorker.register("sw.js",{scope:"./"});for(;!e.active;);await this.client.loadWorker(e.active),console.log("Service Worker ready"),this.client.on("error",(function(t){console.error("ERROR: "+t.message)})),this.client.add(this.torrentId,(async e=>{e.on("warning",(t=>{console.warn(t)})),e.on("error",(t=>{console.error(t)})),e.files[this.fileIdx].streamTo(t)}))})),this.torrentId=e,this.fileIdx=i,this.client=new window.WebTorrent}}function i(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6e3,o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return function*(){let s=0;const n=new AbortController;async function a(t){if(!(s<i)||n.signal.aborted){if(n.signal.aborted)throw"aborted";return await new Promise(((t,e)=>setTimeout(t,r))),await a(t)}try{s++;const i=await e(t);if(n.signal.aborted)throw"aborted";return o&&n.abort(),i}finally{s--}}for(const e of t)yield a(e)}()}function r(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}t(e,"IS_CLIENT_COMPATIBLE",(()=>WebTorrent.WEBRTC_SUPPORT&&!!navigator.serviceWorker));class o{constructor(t,e,o){r(this,"responseTimeout",6e3),r(this,"retryTimeout",2e3),r(this,"concurrency",8),r(this,"MOST_POPULAR_GETAWAYS",["192.168.1.1","192.168.0.1","192.168.2.1","192.168.1.254","192.168.10.1","192.168.100.1","192.168.0.50","192.168.0.254","192.168.88.1","192.168.123.254","192.168.8.1","10.0.0.1","192.168.1.2","192.168.11.1","10.0.0.2","192.168.1.240","192.168.1.250","192.168.3.1","192.168.20.1","10.0.0.138","192.168.254.254","192.168.15.1","172.19.3.1","192.168.1.245","10.1.1.1","192.168.10.100","192.168.16.1","10.10.10.254","192.168.0.20","192.168.0.100","192.168.178.1","192.168.0.30","192.168.1.20","192.168.2.2","192.168.1.253","192.168.0.10","192.168.2.254","10.10.10.1","192.168.0.99","192.168.1.100","192.168.31.1","192.168.168.168","192.168.100.252","192.168.62.1","192.168.50.1","192.168.111.1","192.168.1.252","192.168.1.230","192.168.30.1","192.168.10.30","192.168.8.254","192.168.0.228","10.0.10.254","192.168.0.101","172.16.0.1","192.168.200.1","192.168.0.32","192.168.1.226","10.0.1.1","10.90.90.91","169.254.128.132","192.168.0.227","192.168.169.1","192.168.6.1","192.168.168.1","192.168.1.200","192.168.1.10","192.168.1.99","192.168.1.241","192.168.7.2","192.168.61.1","192.168.80.240","222.222.222.1","10.90.90.90","192.168.9.2","10.1.0.99","172.23.56.254","192.168.0.2","192.168.18.1","192.168.10.110","10.10.1.1","192.168.16.254","10.1.10.1","192.0.2.1","192.168.5.1","192.168.1.251","192.168.16.168","192.168.190.1","192.168.22.1","192.168.1.225","192.168.123.1","192.168.42.1","192.168.0.40","192.168.40.1","192.168.0.35","192.168.32.1","192.168.0.4","10.8.0.99","192.168.0.3"]),r(this,"updatePossibleIps",(()=>{if(this.possibleLocalIps=[],!this.getaway)throw"No getaway detected. Impossible to parse local ips.";const t=this.getaway.split(".").splice(0,3).join(".");for(let e=0;e<=255;e++)this.possibleLocalIps.push(t+"."+e)})),r(this,"checkAddress",(t=>{const e=this.responseTimeout;return new Promise(((i,r)=>{const o=new WebSocket(`wss://${t}/`),s=Date.now();setTimeout((()=>o.close()),e),o.onclose=o=>{Date.now()-s<e?(console.log(`Possible local ip: ${t}`),i(t)):r(t)}}))})),r(this,"checkServer",(async t=>{const e=new AbortController;setTimeout((()=>e.abort()),this.responseTimeout);const i=await fetch(`http://${t}`,{signal:e.signal});if(!e.signal.aborted)return{ip:t,text:await i.text()+""}})),r(this,"detectGetaway",(async()=>{this.getaway=await Promise.any(i(this.MOST_POPULAR_GETAWAYS,this.checkAddress,this.concurrency,this.retryTimeout,!0)),this.updatePossibleIps()})),this.responseTimeout=t||this.responseTimeout,this.retryTimeout=e||this.retryTimeout,this.concurrency=o||this.concurrency,this.getaway=null,this.privateIps=[],this.possibleLocalIps=[]}}function s(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class n{constructor(){var t=this;let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";s(this,"TIMEOUT",6e3),s(this,"MAX_CONNECTIONS",3),s(this,"PORT",8090),s(this,"init",(async function(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(t.url)try{const e=await fetch(`http://${t.url}:${t.PORT}/echo`);t.version=(await e.text()).match(/MatriX\.\d{1,3}/)[0]}catch(e){console.warn(`No server at ${t.url}}`)}if(t.version)console.log(`Server ready at '${t.url}'`);else{if(!e)throw`No server at ${t.url}}`;if(await t.detectUrl(),!t.version)throw"No server in network";console.log(`Server ready at '${t.url}'`)}})),s(this,"detectUrl",(async()=>{const t=new o(this.TIMEOUT,this.TIMEOUT/4);await t.detectGetaway();const e=await Promise.any(i(t.possibleLocalIps,(async e=>{await t.checkAddress(e);const i=await t.checkServer(`${e}:8090/echo`);if(i?.text.match(/MatriX\.\d{1,3}/))return{ip:e,version:i.text};throw`No TorrServer here (${e})`}),this.MAX_CONNECTIONS,this.TIMEOUT,!0));this.url=e.ip,this.version=e.version})),s(this,"streamTorrent",(async(t,e,i)=>{const r={link:t,index:e,play:!0};i.src=`http://${this.url}:${this.PORT}/stream?${new URLSearchParams(r)}`;const o=await(await fetch(`http://${this.url}:${this.PORT}/stream?${new URLSearchParams({...r,m3u:!0})}`)).text(),s="#EXTVLCOPT:input-slave=",n=o.substring(o.indexOf(s)+s.length).split("#").map((t=>t.trim())).filter((t=>t.match(/(?:\.srt)|(?:\.vtt)/)));console.log(n)})),this.url=e,this.version=null}}const a=(t,e,i,r)=>({id:t,headline:e,text:i,type:"space",layout:r}),l=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return{id:t,label:i?null:(arguments.length>3&&void 0!==arguments[3]?arguments[3]:null)||t,key:t,action:`player:commit:message:input:${t}`,type:"button",layout:e,...i&&{icon:i},alignment:"justify",centration:"label"}},c="torrent:",u=(t,e)=>{TVXVideoPlugin.error(t),e&&e()};class h{constructor(){this.videoElement=document.getElementById("video"),this.torrServerLocation=null,this.serverLocationInput="",this.torrentId=null,this.fileIdx=0,this.player=null,this.init=()=>{},this.playLocaly=()=>{this.player=new e(this.torrentId,this.fileIdx),this.player.streamTorrent(this.videoElement)},this.playRemotely=async()=>{console.log("Setting remote player"),this.player=new n("auto"==this.serverLocation?null:this.serverLocation),"auto"==this.serverLocation&&("No server ip was supplied, the system will attempt to locate one automatically.",TVXVideoPlugin.warn("No server ip was supplied, the system will attempt to locate one automatically."),TVXVideoPlugin.startLoading());try{await this.player.init(),((t,e)=>{TVXVideoPlugin.success(t)})(`TorrServer ${"auto"==this.serverLocation?"found":"available"} at ${this.player.url}`),this.player.streamTorrent(this.torrentId,this.fileIdx,this.videoElement)}catch(t){u("auto"==this.serverLocation?"No server was found in this network":"No server was found at the specified IP",(()=>{console.error(t)}))}},this.ready=()=>{TVXVideoPlugin.requestData("video:info",(t=>{const i=t?.video?.info;this.torrentId=TVXPropertyTools.getFullStr(i,c+"id",null)||new TVXUrlParams(window.location.href).getFullStr("torrent",null),this.fileIdx=TVXPropertyTools.getNum(i,c+"fileIdx",null)||new TVXUrlParams(window.location.href).getNum("fileIdx",0),this.torrentId||u("Error: No torrent id (infoHash, magnerURI or .torrent file) specified.",(()=>{throw"No torrent id"}));const r=TVXPropertyTools.getBool(i,c+"server:precedence",!1),o=e.IS_CLIENT_COMPATIBLE(),s=TVXPropertyTools.getFullStr(i,c+"server:location","auto");this.serverLocation=s,this.serverLocationInput=s,r?this.playRemotely():o?this.playLocaly():u("Your system does not support WebTorrent. Will try to connect to a TorrServer as fallback.",this.playRemotely)})),TVXVideoPlugin.startPlayback()},this.play=()=>this.videoElement.play(),this.pause=()=>this.videoElement.pause(),this.stop=()=>{this.videoElement.pause(),TVXVideoPlugin.stopPlayback()},this.getDuration=()=>this.videoElement.duration,this.getPosition=()=>this.videoElement.currentTime,this.getSpeed=()=>this.videoElement.playbackRate,this.setSpeed=t=>{this.videoElement.playbackRate=t},this.setPosition=t=>{this.videoElement.currentTime=t},this.isMuted=()=>this.videoElement.muted,this.setMuted=()=>{this.videoElement.muted=!0},this.getUpdateData=()=>({position:this.getPosition(),duration:this.getDuration(),speed:this.getSpeed()}),this.handleEvent=function(t){},this.handleData=t=>{var e,i;0==t?.message.indexOf("input:")?(this.serverLocationInput=(e=this.serverLocationInput,(i=t.message.substring(6))in["1","2","3","4","5","6","7","8","9","0"]?e+i:"delete"==i?e.substring(0,e.length-1):"period"==i?e+".":"auto"==i?"auto":e),TVXVideoPlugin.executeAction("update:panel:torrserverlocation",{label:this.serverLocationInput})):"serverLocationChange"==t?.message&&(this.serverLocation=this.serverLocationInput,this.playRemotely())},this.handleRequest=(t,i,r)=>{var o;"options"==t&&r((o=this.serverLocationInput,console.log("optionsPanel()"),{cache:!1,reuse:!1,headline:"Options",pages:[{items:[a("webtorrent","WebTorrent Support",`Your system ${e.IS_CLIENT_COMPATIBLE()?"{txt:msx-green:supports}":"{txt:msx-red:does not support}"} WebTorrent streaming directly to the client.`,"0,0,8,1"),a("torrserver","TorrServer Setup","Local (private) ip of your TorrServer (ex. 192.168.1.9:8090)","0,1,8,1"),{focus:!1,id:"torrserverlocation",type:"button",label:o,layout:"0,2,8,1"},l("1","0,3,1,1"),l("2","1,3,1,1"),l("3","2,3,1,1"),l("4","3,3,1,1"),l("5","4,3,1,1"),l("6","5,3,1,1"),l("7","6,3,1,1"),l("8","7,3,1,1"),l("9","0,4,1,1"),l("0","1,4,1,1"),l("period","2,4,1,1",null,"."),l("delete","3,4,1,1","backspace"),{id:"auto",label:'"auto"',action:"player:commit:message:input:auto",type:"control",layout:"4,4,2,1",icon:"devices"},{id:"submit",label:"Submit",action:"player:commit:message:serverLocationChange",type:"control",layout:"6,4,2,1",icon:"network-check"}]}]}))}}}TVXPluginTools.onReady((function(){TVXVideoPlugin.setupPlayer(new h),TVXVideoPlugin.init()}))})();