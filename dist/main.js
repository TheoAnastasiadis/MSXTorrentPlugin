/*! For license information please see main.js.LICENSE.txt */
(()=>{"use strict";var e={622:e=>{function t(e,t){return{start:e.start,end:e.end,index:t}}function r(e){return{start:e.start,end:e.end}}function n(e,t){return e.index-t.index}function o(e,t){return e.start-t.start}e.exports=function(e,i,s){if("string"!=typeof i)throw new TypeError("argument str must be a string");var a=i.indexOf("=");if(-1===a)return-2;var d=i.slice(a+1).split(","),l=[];l.type=i.slice(0,a);for(var u=0;u<d.length;u++){var c=d[u].split("-"),p=parseInt(c[0],10),g=parseInt(c[1],10);isNaN(p)?(p=e-g,g=e-1):isNaN(g)&&(g=e-1),g>e-1&&(g=e-1),isNaN(p)||isNaN(g)||p>g||p<0||l.push({start:p,end:g})}return l.length<1?-1:s&&s.combine?function(e){for(var i=e.map(t).sort(o),s=0,a=1;a<i.length;a++){var d=i[a],l=i[s];d.start>l.end+1?i[++s]=d:d.end>l.end&&(l.end=d.end,l.index=Math.min(l.index,d.index))}i.length=s+1;var u=i.sort(n).map(r);return u.type=e.type,u}(l):l}}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}(()=>{var e=r(622);function t(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class n{constructor(r,n){t(this,"streamTorrent",(()=>{const t=navigator.serviceWorker.register("sw.js",{scope:"/"});var r;r=this.client,navigator.serviceWorker.addEventListener("message",(t=>{const n=new Request(t.data.url,{headers:t.data.headers,method:t.data.method}),[o]=t.ports,i=e=>o.postMessage(e),s=n.url.split(t.data.scope+"webtorrent/")[1];let[a,...d]=s.split("/");if(d=decodeURI(d.join("/")),!a||!d)return;const l=r.get(a).files.find((e=>e.path===d)),[u,c]=function(t,r){const n={status:200,headers:{"Content-Type":t._getMimeType(),"Accept-Ranges":"bytes"}};let o=e(t.length,r.headers.get("range")||"");return Array.isArray(o)?(n.status=206,o=o[0],n.headers["Content-Range"]=`bytes ${o.start}-${o.end}/${t.length}`,n.headers["Content-Length"]=""+(o.end-o.start+1)):(o=null,n.headers["Content-Length"]=t.length),n.body="HEAD"===r.method?"":"stream",[n,"GET"===r.method&&t.createReadStream(o)]}(l,n),p=c&&c[Symbol.asyncIterator]();i(u),o.onmessage=async function(){i((await p.next()).value)}})),this.client.on("error",(function(e){console.error("ERROR: "+e.message)})),this.client.add(this.torrentId,(async e=>{await t;const r=document.createElement("video");r.id="video",r.autoplay=!0,r.preload=!0;const n=document.createElement("source");n.src=`/webtorrent/${e.infoHash}/${encodeURI(e.files[this.fileIdx].path)}`,n.type=`video/${n.src.split(".")[-1]}`,r.appendChild(n),document.body.appendChild(r)}))})),this.torrentId=r,this.fileIdx=n,this.client=new WebTorrent}}t(n,"IS_CLIENT_COMPATIBLE",(()=>WebTorrent.WEBRTC_SUPPORT&&!!navigator.serviceWorker));const o=n,i="torrent:";class s{constructor(){this.init=()=>{},this.ready=()=>{TVXVideoPlugin.requestData("video:info",(e=>{const t=e?.video?.info,r=TVXPropertyTools.getFullStr(t,i+"id",null)||new TVXUrlParams(window.location.href).getFullStr("torrent",null),n=TVXPropertyTools.getNum(t,i+"fileIdx",null)||new TVXUrlParams(window.location.href).getNum("fileIdx",0);if(!r)return void TVXVideoPlugin.error("Error: No torrent id (infoHash, magnerURI or .torrent file) specified.");const s=TVXPropertyTools.getBool(t,i+"server:precedence",!1);o.IS_CLIENT_COMPATIBLE()&&!s?function(e,t){console.log(`Local player: (${e}, ${t})`),new o(e,t).streamTorrent()}(r,n):TVXVideoPlugin.error("Your system does not support WebTorrent. Will try to use TorrServer as fallback...")})),TVXVideoPlugin.startPlayback()},this.play=()=>{document.getElementById("video")?.play()},this.pause=()=>{document.getElementById("video").pause()},this.stop=()=>{document.getElementById("video").pause(),TVXVideoPlugin.stopPlayback()},this.getDuration=()=>document.getElementById("video").duration,this.getPosition=()=>document.getElementById("video").currentTime,this.setPosition=e=>{document.getElementById("video").currentTime=e},this.setMuted=()=>{document.getElementById("video").muted=!0},this.isMuted=()=>document.getElementById("video").muted,this.getSpeed=()=>document.getElementById("video").playbackRate,this.setSpeed=e=>{document.getElementById("video").playbackRate=e},this.getUpdateData=()=>({position:this.getPosition(),duration:this.getDuration(),speed:this.getSpeed()})}}TVXPluginTools.onReady((function(){TVXVideoPlugin.setupPlayer(new s),TVXVideoPlugin.init()}))})()})();